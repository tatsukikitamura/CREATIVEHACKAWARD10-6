# MBTI性格診断テスト（CREATIVEHACKAWARD10-6）

本番サイト: https://mbti-search-854b363bf31b.herokuapp.com/

AIが動的に生成する質問に答えるだけで、MBTI性格タイプを診断・可視化するWebアプリです。4つの次元（外向性/内向性、感覚/直感、思考/感情、判断/知覚）をもとに回答し、16タイプから最適なタイプを推定します。

## 目次
- アプリケーションの概要
  - 目的（Purpose）
  - 対象ユーザー（Who）
  - 提供価値（Value Proposition）
  - 代表的ユースケース（Use Cases）
  - 体験フロー（User Journey）
  - 差別化ポイント（USP）
  - 設計思想（Design Principles）
  - 今後の展望（Roadmap）
- 開発者向け付録
  - 要件（Ruby / Rails / DB / 外部サービス）
  - クイックスタート
  - ローカル開発（bin/setup）
  - Dockerでの起動
  - 環境変数
  - 技術スタック
  - 主要機能
  - APIエンドポイント
  - 開発メモ（UI/ナビゲーション）
  - デプロイ（Heroku）
  - 補助ドキュメント
  - トラブルシューティング / FAQ
  - ライセンス

## アプリケーションの概要
### 目的（Purpose）
自己理解を深める対話的な体験を提供し、MBTIの枠を越えて「物語」「音楽」「画像」を通じて多面的にパーソナリティを可視化します。

### 対象ユーザー（Who）
- 自己分析・キャリア探索・創作インスピレーションを求める個人
- ワークショップやカウンセリングでのアイスブレイクを行うファシリテーター
- 企画・コンテンツ制作におけるアイデア発火装置を求めるクリエイター

### 提供価値（Value Proposition）
- AIが物語文脈に沿って質問を生成し、直感的に回答しやすい
- 結果を静的なラベルではなく、音楽・画像・物語の多層表現として提示
- 回答の蓄積から文脈に沿った解釈・示唆を返すため、自己理解が深まる

### 代表的ユースケース（Use Cases）
- 個人のセルフリフレクション（定期的な内省のトリガー）
- チームビルディングでの相互理解のきっかけ作り
- 作品制作前のキャラクター・世界観設計のインスピレーション獲得

### 体験フロー（User Journey）
1. 物語モードを選ぶ（ホラー/アドベンチャー/ミステリー/クリエイター/カスタム）
2. 物語調の質問に回答（AIが履歴と設定に応じて次の質問を生成）
3. 結果画面でタイプ傾向と根拠のストーリーを確認
4. 音楽提案・画像生成・レポートで多面的に理解を補強

### 差別化ポイント（USP）
- 物語モードで回答のハードルを下げ、自然な自己開示を促進
- 個別化AI分析により、単純なタイプ分類を超えた意味づけ
- 音楽・画像・物語の多面的な表現で解釈の幅を拡張

### 設計思想（Design Principles）
- ラベル付けではなく、文脈と関係性を重視した解釈
- 説明可能性（根拠の提示）と詩的表現（インスピレーション）の両立
- ユーザー主導（カスタム物語）とAI支援のハイブリッド

### 今後の展望（Roadmap）
- セッションの長期学習（再訪時の継続的パーソナライズ）
- コミュニティ共有用の匿名プロファイル/プレイリスト
- マルチモーダル入力（画像・音声）対応

## システム構成

このアプリは、ユーザーがブラウザで操作すると、サーバー側でAIが質問を生成して診断を行う仕組みになっています。以下、どうやって作ったかをわかりやすく説明します。

### 全体の仕組み（簡単に言うと）

アプリは4つの層（レイヤー）に分かれています。料理に例えると：
- **Controller（コントローラー）**: お客さんからの注文を受け取る店員さん
- **Service（サービス）**: 実際に料理を作るシェフ
- **Model（モデル）**: 食材やレシピを管理する倉庫
- **Database（データベース）**: 食材を保存する冷蔵庫

```
┌─────────────────────────────────────────────────────────┐
│                  ユーザー（ブラウザ）                      │
│              「診断を始めたい！」とクリック                 │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            Controller（店員さん）                          │
│  「診断を始めますね。セッションIDを作ります」                │
│  「次の質問を表示します」                                   │
│  「回答を受け取りました。次へ進みます」                     │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            Service（シェフ）                              │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐ │
│  │AI質問生成係   │  │音楽提案係     │  │画像生成係     │ │
│  │「物語調の質問 │  │「このタイプに │  │「性格に合う  │ │
│  │ を作ります」  │  │ 合う音楽は」  │  │ 画像を作ります」│ │
│  └──────────────┘  └──────────────┘  └──────────────┘ │
│  ┌──────────────────────────────────────────────────┐   │
│  │  ゲームマスター係                                 │   │
│  │  「物語の次の場面を作ります」                      │   │
│  └──────────────────────────────────────────────────┘   │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            Model（倉庫管理）                              │
│  ┌──────────────┐  ┌──────────────┐                    │
│  │診断セッション │  │結果計算       │                    │
│  │「今どこまで  │  │「スコアを     │                    │
│  │ 進んだか管理」│  │ 集計します」  │                    │
│  └──────────────┘  └──────────────┘                    │
└────────────────────┬────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            Database（冷蔵庫）                             │
│  質問と回答を保存する場所                                  │
└─────────────────────────────────────────────────────────┘
                     │
┌────────────────────▼────────────────────────────────────┐
│            OpenAI（外部のAIサービス）                      │
│  「質問を作ってください」→ AIが質問を生成                   │
└─────────────────────────────────────────────────────────┘
```

### 各パートの役割

#### 1. Controller（コントローラー）: 店員さんの役割

**何をするか**: ユーザーからのリクエストを受け取り、適切な処理に振り分けます。

**具体的な仕事**:
- 診断を始める時: ユーザーごとに一意のID（セッションID）を作成
- 質問を表示する時: データベースから質問を取得して画面に渡す
- 回答を受け取る時: 回答を保存して、次の質問へ進む
- 結果を表示する時: 計算された結果を画面に表示

**なぜこうしたか**: 
- ユーザーが途中で離れても、IDがあれば続きから再開できるように
- 未完了の診断で結果画面を見られないように制御

#### 2. Service（サービス）: シェフの役割

**何をするか**: 実際の「仕事」を担当します。AIとのやり取りや、複雑な計算を行います。

##### AI質問生成係（OpenaiService）

**仕事内容**:
- OpenAIに「物語調の質問を作ってください」とお願いする
- 前回の回答を考慮して、続きの物語になる質問を生成
- もしAIが使えない時は、予備の質問を使う

**なぜ分けたか**: 
- AIとのやり取りを一箇所にまとめることで、後で変更しやすく
- エラーが起きても、予備の質問で診断を続けられるように

##### ゲームマスター係（AiGameMasterService）

**仕事内容**:
- 物語の次の場面を作る（「森の中に迷い込んだ...」など）
- プレイヤーの選択に応じて物語を進める
- 物語が終わったら、エンディングと分析を生成

**なぜこうしたか**:
- ゲームのように楽しみながら診断できるように
- 各場面で異なる性格の側面を測れるように

##### 音楽・画像生成係

**仕事内容**:
- 診断結果に合う音楽を提案
- 性格を表現する画像を生成

#### 3. Model（モデル）: 倉庫管理の役割

**何をするか**: データの保存や計算を担当します。

##### 診断セッション（MbtiSession）

**仕事内容**:
- 今、何問目まで進んだか記録
- 質問と回答を保存
- 途中で終了できるように（最低3問は必要）

**なぜこうしたか**:
- ユーザーが何度でも診断できるように
- 途中で離れても、続きから再開できるように

##### 結果計算（MbtiResult）

**仕事内容**:
- 回答を集計して、どのMBTIタイプかを計算
- 各次元（外向/内向、感覚/直感など）のスコアを出す

**なぜこうしたか**:
- データベースに保存せず、その場で計算する方がシンプル
- エラーが起きても、デフォルトのタイプを返すように

#### 4. データベース: 冷蔵庫の役割

**何を保存するか**:

```
mbti_sessions（診断セッションの記録）
├── session_id: ユーザーごとのID（例: "abc-123-def"）
├── questions: 生成された質問のリスト
├── answers: ユーザーの回答のリスト
├── current_question_index: 今、何問目か（0, 1, 2...）
├── completed: 診断が終わったか（true/false）
├── story_mode: 選んだ物語モード（ホラー、アドベンチャーなど）
├── story_state: ゲームマスターモードの状態（進捗、持ち物など）
└── custom_story: カスタム物語の設定
```

**なぜこうしたか**:
- JSON形式で保存することで、後から質問の形式を変えても対応しやすい
- ユーザーごとに独立した診断を管理できるように

#### 5. プロンプト設計: AIへのお願い文

**何をするか**: AIに「こんな質問を作ってください」とお願いする文章（プロンプト）を管理します。

**なぜ分けたか**:
- プロンプトを一箇所にまとめることで、後で調整しやすく
- 物語モードごと（ホラー、アドベンチャーなど）に異なるプロンプトを使えるように

**具体的には**:
- MBTIの4つの次元（外向/内向、感覚/直感、思考/感情、判断/知覚）ごとに説明を用意
- 前回の回答を考慮して、続きの物語になるように

#### 6. エラー時の対応: 予備の質問

**何をするか**: AIが使えない時でも、診断を続けられるように予備の質問を用意しています。

**なぜ必要か**:
- AIのサービスが止まっても、アプリが動き続けるように
- エラー画面ではなく、普通の質問で診断を続けられるように

### 実際の流れ: 質問が表示されるまで

```
1. ユーザーが「診断を始める」ボタンをクリック
   ↓
2. Controllerが「この人のIDを作ります」と処理
   ↓
3. ユーザーが「アドベンチャーモード」を選択
   ↓
4. Controllerが「アドベンチャーモードで保存しました」と処理
   ↓
5. Controllerが「次の質問を表示します」と処理
   ↓
6. Service（AI質問生成係）が「AIに質問を作ってもらいます」と依頼
   - 前回の回答を考慮
   - 物語の続きになるように
   ↓
7. 質問ができたら、データベースに保存
   ↓
8. 画面に質問が表示される
   ↓
9. ユーザーが回答を選択
   ↓
10. Controllerが「回答を保存しました。次へ進みます」と処理
    ↓
11. 次の質問へ（ステップ5に戻る）
```

### なぜこういう設計にしたか

#### なぜサービス層を分けたか

**理由**: コードを整理するため

- Controllerは「ユーザーからのリクエストを受け取る」ことに専念
- Serviceは「実際の仕事（AIとのやり取りなど）」を担当
- こうすることで、後で変更する時やテストする時が楽になる

**例**: 料理店で、注文を受け取る人と作る人が分かれているのと同じ

#### なぜJSON形式で保存したか

**理由**: 後から変更しやすいため

- 質問の形式を変えたい時、データベースの構造を変えなくて済む
- 新しい機能（ゲームマスターなど）を追加する時も、既存のテーブルに追加するだけで済む

**例**: 引き出しにラベルを貼るのではなく、中身を自由に変えられる箱を使う感じ

#### なぜランダムに次元を選ぶようにしたか

**理由**: より自然な体験のため

- 固定の質問セットではなく、物語の流れに沿って質問を生成
- 各次元（外向/内向など）を均等にカバーするように調整
- ユーザーが満足するまで、何問でも続けられる

**例**: 決まったコースではなく、その日の気分に合わせて料理を選べる感じ

#### なぜ予備の質問を用意したか

**理由**: エラーが起きても動き続けるため

- AIのサービスが止まっても、アプリが動き続ける
- エラー画面ではなく、普通の質問で診断を続けられる
- ユーザー体験を損なわない

**例**: メインの料理が作れなくても、予備のメニューで対応できる感じ

### 開発の流れ（どうやって作ったか）

1. **最初の設計**: アプリの全体像を決める（どんな機能が必要か）
2. **データベースの設計**: どんな情報を保存するか決める
3. **基本機能の実装**: 質問を表示 → 回答を保存 → 結果を表示、の流れを作る
4. **AIとの連携**: OpenAIのAPIを使って、質問を自動生成できるように
5. **機能の追加**: 物語モード、ゲームマスター、カスタム物語を順番に追加
6. **エラー対応**: AIが使えない時の予備機能を追加
7. **見た目の改善**: スタイルを整えて、使いやすくする

## 開発者向け付録

## 要件（Requirements）
- Ruby: 3.3.0（`.ruby-version`）
- Rails: 8.0系（`Gemfile`）
- DB: PostgreSQL
- 外部サービス: OpenAI（テキスト生成）、DALL·E 3（画像）


## クイックスタート
```bash
bundle install
bin/rails db:setup
bin/rails s
```
ブラウザで http://localhost:3000 を開きます。

## ローカル開発（bin/setup）
初回セットアップや依存関係更新は以下で自動化されています。

```bash
bin/setup
```

実行内容の要点:
- Bundlerのインストールと `bundle install`
- `bin/rails db:prepare` によるDB準備
- ログ/一時ファイルのクリアとアプリの再起動

## Dockerでの起動
アプリのDockerイメージは `Dockerfile` で定義されています。DBをDockerで使う場合は `docker-compose.yml` の `postgres` サービスを起動してください。

1) PostgreSQL の起動
```bash
docker compose up -d postgres
```

2) アプリの起動（例: ビルドして起動）
```bash
docker build -t mbti-app .
docker run --rm -p 3000:3000 \
  -e RAILS_ENV=development \
  -e DATABASE_URL=postgres://postgres:password@host.docker.internal:5432/creativehackaward10_6_development \
  --name mbti-app mbti-app
```

メモ: ネットワークやホスト名は環境に合わせて調整してください（WSL2の場合は `host.docker.internal` が使える前提）。

## 環境変数
`.env`（`dotenv-rails`）で管理します。

```bash
OPENAI_API_KEY=sk-xxxxx
```

必要に応じて以下も設定:
- `DATABASE_URL`（本番: PostgreSQL）
- `RAILS_MASTER_KEY`（本番資格情報使用時）

## 技術スタック（Tech Stack）
- Backend: Rails 8 / Ruby 3.3.0
- Frontend: Turbo / Stimulus / Importmap
- Database: 本番 PostgreSQL（Heroku Postgres）/ 開発 SQLite3
- AI/ML: OpenAI GPT-4, DALL·E 3
- 主要モデル:
  - `MbtiSession`（質問・回答・進行状況・物語モードを保存）
  - `MbtiResult`（MBTIタイプ計算・分析）
- 外部API:
  - OpenAI（質問生成・分析・音楽提案・画像生成）
  - DALL·E 3（高品質な画像生成）
- 主要サービス:
  - `OpenaiService`（質問生成・分析）
  - `AiMusicService`（音楽提案・プレイリスト生成）
  - `AiPhotoService`（画像生成・プロンプト管理）

## 主要機能
### 基本診断機能
- AI生成質問（物語仕立て）
- 物語モード（ホラー/アドベンチャー/ミステリー/クリエイター）
- 進捗管理（サーバセッション）
- 結果表示（各次元スコアとタイプ）
- リアルタイム更新

### AI診断機能
- 個別化分析（回答と物語設定に基づく）
- 音楽提案（ジャンル/アーティスト/楽曲）
- 画像生成（抽象・自然/風景・日常シーン）
- プレイリスト作成

### 物語設定機能
- カスタム物語（舞台/テーマ/雰囲気/キャラ背景）
- 文脈に応じた生成
- 多様な表現

## APIエンドポイント
### 診断関連
- `GET /mbti` - 診断開始
- `POST /mbti/answer` - 質問回答
- `GET /mbti/result` - 基本結果表示
- `GET /mbti/result_ai` - AI診断結果表示

### AI生成関連
- `POST /mbti/generate_music` - 音楽提案生成
- `POST /mbti/generate_image` - 画像生成
- `POST /mbti/personalized_report` - 個別化レポート生成


## デプロイ（Heroku）
```bash
git push heroku main
heroku run rails db:migrate
```
リリース時に自動マイグレーションを行う場合は `Procfile` に以下を追加:
```
release: bundle exec rails db:migrate
```

## 補助ドキュメント
- `MBTI_README.md`: 差別化ポイントの要約
- `docs/production.txt`: 本番運用に関するメモ
- `docs/2024.txt`: 開発履歴・補足

## トラブルシューティング / FAQ
- サーバ起動時にRuby/Railsの不整合が出る
  - `ruby -v` が `3.3.0` であることを確認し、`bundle install` を再実行
  - Docker利用時は `Dockerfile` の `ARG RUBY_VERSION` を `3.3.0` に揃える
- DB接続エラー（Postgres）
  - `docker compose ps` で `postgres` が `healthy` か確認
  - 接続情報（ユーザ/パスワード/ポート）を `docker-compose.yml` と一致させる
- OpenAIのエラー
  - `OPENAI_API_KEY` が正しいか、API利用制限を超えていないか確認

## ライセンス
このリポジトリの内容はプロジェクトの目的に従って利用してください。
