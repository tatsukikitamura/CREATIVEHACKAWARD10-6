<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>MBTIè¨ºæ–­çµæœ</title>
  <%= stylesheet_link_tag 'mbti_result', 'data-turbo-track': 'reload' %>
</head>
<body>
  <div class="container">
    <div class="header">
      <div class="result-icon">ğŸ¯</div>
      <h1 class="mbti-type"><%= @result.mbti_type %></h1>
      <p class="mbti-description"><%= @result.description %></p>
      
      <% if @answer_count < 20 %>
        <div class="warning-message">
          <div class="warning-icon">âš ï¸</div>
          <div class="warning-text">
            <strong>è¨ºæ–­ç²¾åº¦ã«ã¤ã„ã¦</strong><br>
            å›ç­”æ•°ãŒ<%= @answer_count %>å•ã¨å°‘ãªã„ãŸã‚ã€è¨ºæ–­çµæœã®ç²¾åº¦ãŒä½ã„å¯èƒ½æ€§ãŒã‚ã‚Šã¾ã™ã€‚<br>
            ã‚ˆã‚Šæ­£ç¢ºãªè¨ºæ–­ã®ãŸã‚ã«ã¯ã€20å•ä»¥ä¸Šå›ç­”ã™ã‚‹ã“ã¨ã‚’ãŠå‹§ã‚ã—ã¾ã™ã€‚
          </div>
        </div>
      <% end %>
    </div>

    <div class="scores-container">
      <h2 class="scores-title">è©³ç´°ã‚¹ã‚³ã‚¢</h2>
      <div class="dimensions">
        <% @result.dimension_scores.each do |dimension_name, scores| %>
          <div class="dimension">
            <div class="dimension-name"><%= dimension_name %></div>
            <div class="dimension-scores">
              <% dominant_type, _dominant_score = scores.max_by { |_, v| v } %>
              <div class="score-item">
                <div class="score-label">å„ªå‹¢ã‚¿ã‚¤ãƒ—</div>
                <div class="score-value"><%= dominant_type %></div>
              </div>
            </div>
            <div class="score-bar">
              <% 
                total = scores.values.sum
                first_type = scores.keys.first
                second_type = scores.keys.last
                first_percentage = total > 0 ? (scores[first_type].to_f / total * 100).round : 50
                second_percentage = 100 - first_percentage
              %>
              <div class="score-fill <%= first_type.downcase %>" style="width: <%= first_percentage %>%"></div>
            </div>
            <div style="display: flex; justify-content: space-between; font-size: 0.8rem; color: #666;">
              <span><%= first_type %></span>
              <span><%= second_type %></span>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <div class="actions">
      <a href="<%= mbti_resume_path(session_id: @mbti_session.session_id) %>" class="action-button continue-button">ç¶šãã‹ã‚‰å†é–‹ã™ã‚‹</a>
      <a href="<%= mbti_path %>" class="action-button">ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
      <button onclick="shareResult()" class="action-button secondary">çµæœã‚’å…±æœ‰</button>
      <!-- <button id="analyze-button" class="action-button secondary" data-session-id="<%= @mbti_session.session_id %>">ã•ã‚‰ã«åˆ†æã™ã‚‹</button> -->
      <a href="<%= mbti_result_ai_path(session_id: @mbti_session.session_id) %>" class="action-button ai-button">ğŸ¤– AIè¨ºæ–­ã§è©³ç´°åˆ†æ</a>
      <button id="personalized-report-button" class="action-button primary" data-session-id="<%= @mbti_session.session_id %>">ã‚ãªãŸã ã‘ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</button>
    </div>

    <div class="share-section" id="share-section" style="display: none;">
      <h3 class="share-title">çµæœã‚’å…±æœ‰</h3>
      <div class="share-text" id="share-text">
        ç§ã®MBTIã‚¿ã‚¤ãƒ—ã¯ã€Œ<%= @result.mbti_type %>ã€ã§ã™ï¼<br>
        <%= @result.description %><br><br>
        ã‚ãªãŸã‚‚è¨ºæ–­ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ<br>
        <%= request.base_url %>
      </div>
      <button onclick="copyToClipboard()" class="copy-button">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <script>
    // CSRF token
    function csrfToken() {
      const meta = document.querySelector('meta[name="csrf-token"]');
      return meta ? meta.getAttribute('content') : '';
    }
    function shareResult() {
      const shareSection = document.getElementById('share-section');
      if (shareSection.style.display === 'none') {
        shareSection.style.display = 'block';
        shareSection.scrollIntoView({ behavior: 'smooth' });
      } else {
        shareSection.style.display = 'none';
      }
    }

    function copyToClipboard() {
      const shareText = document.getElementById('share-text').textContent;
      navigator.clipboard.writeText(shareText).then(function() {
        alert('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      }, function(err) {
        console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const textArea = document.createElement('textarea');
        textArea.value = shareText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('çµæœã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }

    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    document.addEventListener('DOMContentLoaded', function() {
      const scoreFills = document.querySelectorAll('.score-fill');
      scoreFills.forEach(fill => {
        const width = fill.style.width;
        fill.style.width = '0%';
        setTimeout(() => {
          fill.style.width = width;
        }, 500);
      });
      const analyzeBtn = document.getElementById('analyze-button');
      if (analyzeBtn) {
        analyzeBtn.addEventListener('click', async function() {
          const sessionId = this.getAttribute('data-session-id');
          const existing = document.getElementById('analysis-container');
          if (existing) existing.remove();

          const section = document.createElement('div');
          section.id = 'analysis-container';
          section.className = 'scores-container';
          section.innerHTML = '<h2 class="scores-title">è©³ç´°åˆ†æ</h2><div>åˆ†æä¸­...</div>';
          document.querySelector('.container').appendChild(section);
          section.scrollIntoView({ behavior: 'smooth' });

          try {
            const res = await fetch('/mbti/analyze', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken()
              },
              body: JSON.stringify({ session_id: sessionId, type: '<%= @result.mbti_type %>' })
            });
            if (!res.ok) throw new Error('åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸ');
            const data = await res.json();
            section.innerHTML = `
              <h2 class=\"scores-title\">è©³ç´°åˆ†æï¼ˆ${data.mbti_type}ï¼‰</h2>
              <div style=\"margin-bottom:16px; white-space: pre-wrap;\">${data.type_details || ''}</div>
              <h3 style=\"font-size:1.2rem; margin: 12px 0;\">ã‚ãªãŸã®å›ç­”ã®ã¾ã¨ã‚</h3>
              <div style=\"white-space: pre-wrap;\">${data.answer_summary || ''}</div>
            `;
          } catch (e) {
            section.innerHTML = '<h2 class="scores-title">è©³ç´°åˆ†æ</h2><div style="color:#c00;">åˆ†æã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
          }
        });
      }

      const personalizedReportBtn = document.getElementById('personalized-report-button');
      if (personalizedReportBtn) {
        personalizedReportBtn.addEventListener('click', async function() {
          const sessionId = this.getAttribute('data-session-id');
          const existing = document.getElementById('personalized-report-container');
          if (existing) existing.remove();

          const section = document.createElement('div');
          section.id = 'personalized-report-container';
          section.className = 'scores-container personalized-report';
          section.innerHTML = '<h2 class="scores-title">ğŸ­ ã‚ãªãŸã ã‘ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h2><div class="loading">ç‰©èªã®æ–‡è„ˆã§åˆ†æä¸­...</div>';
          document.querySelector('.container').appendChild(section);
          section.scrollIntoView({ behavior: 'smooth' });

          try {
            const res = await fetch('/mbti/personalized_report', {
              method: 'POST',
              headers: {
                'Content-Type': 'application/json',
                'X-CSRF-Token': csrfToken()
              },
              body: JSON.stringify({ session_id: sessionId, type: '<%= @result.mbti_type %>' })
            });
            if (!res.ok) throw new Error('ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸ');
            const data = await res.json();
            section.innerHTML = `
              <h2 class=\"scores-title\">ğŸ­ ã‚ãªãŸã ã‘ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆï¼ˆ${data.mbti_type}ï¼‰</h2>
              <div class=\"story-mode-badge\">${getStoryModeLabel(data.story_mode)}</div>
              <div class=\"report-section\">
                <h3 class=\"report-section-title\">ğŸ“– ç‰©èªã§ã®ã‚ãªãŸã®é¸æŠåˆ†æ</h3>
                <div class=\"report-content\">${data.story_analysis || ''}</div>
              </div>
              <div class=\"report-section\">
                <h3 class=\"report-section-title\">ğŸ” æ€§æ ¼ã®æ´å¯Ÿ</h3>
                <div class=\"report-content\">${data.personality_insights || ''}</div>
              </div>
              <div class=\"report-section\">
                <h3 class=\"report-section-title\">ğŸŒŸ æˆé•·ã®ãƒ’ãƒ³ãƒˆ</h3>
                <div class=\"report-content\">${data.growth_suggestions || ''}</div>
              </div>
            `;
          } catch (e) {
            section.innerHTML = '<h2 class="scores-title">ğŸ­ ã‚ãªãŸã ã‘ã®è©³ç´°ãƒ¬ãƒãƒ¼ãƒˆ</h2><div style="color:#c00;">ãƒ¬ãƒãƒ¼ãƒˆç”Ÿæˆã«å¤±æ•—ã—ã¾ã—ãŸã€‚æ™‚é–“ã‚’ãŠã„ã¦å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚</div>';
          }
        });
      }

      function getStoryModeLabel(storyMode) {
        const labels = {
          'horror': 'ãƒ›ãƒ©ãƒ¼ãƒ»ã‚¹ãƒªãƒ©ãƒ¼',
          'adventure': 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ»å†’é™º',
          'mystery': 'ãƒŸã‚¹ãƒ†ãƒªãƒ¼ãƒ»æ¨ç†'
        };
        return labels[storyMode] || 'ã‚¢ãƒ‰ãƒ™ãƒ³ãƒãƒ£ãƒ¼ãƒ»å†’é™º';
      }
    });
  </script>
</body>
</html>
