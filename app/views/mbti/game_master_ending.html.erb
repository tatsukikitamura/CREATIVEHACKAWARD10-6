<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‰©èªã®çµæœ« - AIã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼</title>
  <%= stylesheet_link_tag 'mbti_common', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'mbti_game_master', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'footer', 'data-turbo-track': 'reload' %>
</head>
<body>
  <div class="ending-container">
     <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
     <div style="text-align: center; margin-bottom: 40px;">
      <br>
       <h1>ğŸ† ç‰©èªå®Œçµï¼</h1>
       <br>
       <p><%= @achievement %></p>
     </div>

    <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="ending-content">
      <div class="ending-text">
        <%= simple_format(@ending_text) %>
      </div>
    </div>

    <!-- MBTIåˆ†æçµæœ -->
    <div class="analysis-section">
      <h2 class="analysis-title">ğŸ­ ã‚ãªãŸã®æ€§æ ¼åˆ†æ</h2>
      
      <div class="mbti-result-card">
        <div class="mbti-type-display">
          <h3 class="mbti-type"><%= @result.mbti_type %></h3>
          <p class="mbti-description"><%= @result.description %></p>
        </div>
      </div>

      <div class="analysis-content">
        <div class="analysis-item">
          <h4>ğŸ“Š MBTIåˆ†æ</h4>
          <p><%= @mbti_analysis %></p>
        </div>

        <div class="analysis-item">
          <h4>ğŸ” æ€§æ ¼ã®æ´å¯Ÿ</h4>
          <p><%= @personality_insights %></p>
        </div>
      </div>
    </div>

     <!-- ç‰©èªã®æŒ¯ã‚Šè¿”ã‚Š -->
     <div class="story-summary">
       <button class="summary-toggle" onclick="toggleStoryTimeline()">
         <h2 class="summary-title">ğŸ“– ã‚ãªãŸã®ç‰©èªã®è»Œè·¡</h2>
         <span class="toggle-icon" id="timeline-icon">â–¼</span>
       </button>
       <br>
       <div class="story-timeline" id="story-timeline" style="display: none;">
         <% @story_state['history']&.each_with_index do |choice, index| %>
           <div class="timeline-item" style="justify-content: center;">
             <div class="timeline-marker"><%= index + 1 %></div>
             <div class="timeline-content">
               <p>
                 <% if choice.include?('ã‚’é¸æŠ') %>
                   <%# å¤ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã‚’å¤‰æ› %>
                   <% 
                     # ã‚ˆã‚Šè‡ªç„¶ãªè¡¨ç¾ã«å¤‰æ›
                     converted_choice = choice.gsub('ã‚’é¸æŠ', '')
                     converted_choice = converted_choice.gsub('å¤–å‘çš„ãªè¡Œå‹•', 'å¤–å‘çš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('å†…å‘çš„ãªè¡Œå‹•', 'å†…å‘çš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('æ„Ÿè¦šçš„ãªåˆ¤æ–­', 'æ„Ÿè¦šçš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('ç›´æ„Ÿçš„ãªåˆ¤æ–­', 'ç›´æ„Ÿçš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('è«–ç†çš„ãªæ€è€ƒ', 'è«–ç†çš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('æ„Ÿæƒ…çš„ãªåˆ¤æ–­', 'æ„Ÿæƒ…çš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('è¨ˆç”»çš„ãªè¡Œå‹•', 'è¨ˆç”»çš„ãªé¸æŠ')
                     converted_choice = converted_choice.gsub('æŸ”è»Ÿãªå¯¾å¿œ', 'æŸ”è»Ÿãªé¸æŠ')
                   %>
                   <%= converted_choice %>
                 <% else %>
                   <%# æ–°ã—ã„å½¢å¼ã®ãƒ‡ãƒ¼ã‚¿ã¯ãã®ã¾ã¾è¡¨ç¤º %>
                   <%= choice %>
                 <% end %>
               </p>
             </div>
           </div>
         <% end %>
       </div>
     </div>

     <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
     <div class="ending-actions">
      <!-- <a href="<%= mbti_result_ai_path %>?session_id=<%= @mbti_session.session_id %>" class="action-button primary">AIè¨ºæ–­çµæœã‚’è¦‹ã‚‹</a> -->
       <a href="<%= mbti_mode_selection_path %>" class="action-button secondary">æ–°ã—ã„ç‰©èªã‚’å§‹ã‚ã‚‹</a>
       <a href="<%= mbti_path %>" class="action-button secondary">é€šå¸¸ã®è¨ºæ–­ã«æˆ»ã‚‹</a>
     </div>

  </div>

  <script>
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      const endingText = document.querySelector('.ending-text');
      endingText.style.opacity = '0';
      endingText.style.transform = 'translateY(30px)';
      setTimeout(() => {
        endingText.style.transition = 'all 1s ease';
        endingText.style.opacity = '1';
        endingText.style.transform = 'translateY(0)';
      }, 500);

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const timelineItems = document.querySelectorAll('.timeline-item');
      timelineItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-30px)';
        setTimeout(() => {
          item.style.transition = 'all 0.5s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateX(0)';
        }, 1000 + (index * 200));
      });
    });


    function toggleStoryTimeline() {
      const timeline = document.getElementById('story-timeline');
      const icon = document.getElementById('timeline-icon');
      
      if (timeline.style.display === 'none') {
        timeline.style.display = 'block';
        icon.textContent = 'â–²';
        
        // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach((item, index) => {
          item.style.opacity = '0';
          item.style.transform = 'translateX(-30px)';
          setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
          }, 100 + (index * 150));
        });
      } else {
        timeline.style.display = 'none';
        icon.textContent = 'â–¼';
      }
    }
  </script>
  
  <%= render 'shared/footer' %>
</body>
</html>
