<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>ç‰©èªã®çµæœ« - AIã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼</title>
  <%= stylesheet_link_tag 'mbti_common', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'mbti_game_master', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'footer', 'data-turbo-track': 'reload' %>
</head>
<body>
  <div class="ending-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="ending-header">
      <div class="achievement-badge">
        <h1>ğŸ† ç‰©èªå®Œçµï¼</h1>
        <p class="achievement-text"><%= @achievement %></p>
      </div>
    </div>

    <!-- ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆ -->
    <div class="ending-content">
      <div class="ending-text">
        <%= simple_format(@ending_text) %>
      </div>
    </div>

    <!-- MBTIåˆ†æçµæœ -->
    <div class="analysis-section">
      <h2 class="analysis-title">ğŸ­ ã‚ãªãŸã®æ€§æ ¼åˆ†æ</h2>
      
      <div class="mbti-result-card">
        <div class="mbti-type-display">
          <h3 class="mbti-type"><%= @result.mbti_type %></h3>
          <p class="mbti-description"><%= @result.description %></p>
        </div>
      </div>

      <div class="analysis-content">
        <div class="analysis-item">
          <h4>ğŸ“Š MBTIåˆ†æ</h4>
          <p><%= @mbti_analysis %></p>
        </div>

        <div class="analysis-item">
          <h4>ğŸ” æ€§æ ¼ã®æ´å¯Ÿ</h4>
          <p><%= @personality_insights %></p>
        </div>
      </div>
    </div>

    <!-- ç‰©èªã®æŒ¯ã‚Šè¿”ã‚Š -->
    <div class="story-summary">
      <h2 class="summary-title">ğŸ“– ã‚ãªãŸã®ç‰©èªã®è»Œè·¡</h2>
      <div class="story-timeline">
        <% @story_state['history']&.each_with_index do |choice, index| %>
          <div class="timeline-item">
            <div class="timeline-marker"><%= index + 1 %></div>
            <div class="timeline-content">
              <p><%= choice %></p>
            </div>
          </div>
        <% end %>
      </div>
    </div>

    <!-- ã‚¢ã‚¯ã‚·ãƒ§ãƒ³ãƒœã‚¿ãƒ³ -->
    <div class="ending-actions">
      <a href="<%= mbti_game_master_path(story_mode: @mbti_session.story_mode) %>" class="action-button primary">æ–°ã—ã„ç‰©èªã‚’å§‹ã‚ã‚‹</a>
      <a href="<%= mbti_path %>" class="action-button secondary">é€šå¸¸ã®è¨ºæ–­ã«æˆ»ã‚‹</a>
      <button onclick="shareStory()" class="action-button secondary">ç‰©èªã‚’å…±æœ‰</button>
    </div>

    <!-- å…±æœ‰ã‚»ã‚¯ã‚·ãƒ§ãƒ³ -->
    <div class="share-section" id="share-section" style="display: none;">
      <h3 class="share-title">ç‰©èªã‚’å…±æœ‰</h3>
      <div class="share-text" id="share-text">
        ç§ã®MBTIã‚¿ã‚¤ãƒ—ã¯ã€Œ<%= @result.mbti_type %>ã€ã§ã™ï¼<br>
        <%= @result.description %><br><br>
        AIã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ã«ã‚ˆã‚‹ç‰©èªè¨ºæ–­ã§åˆ¤æ˜ã—ã¾ã—ãŸã€‚<br>
        ã‚ãªãŸã‚‚ä½“é¨“ã—ã¦ã¿ã¾ã›ã‚“ã‹ï¼Ÿ<br>
        <%= request.base_url %>/mbti/game_master
      </div>
      <button onclick="copyToClipboard()" class="copy-button">ã‚³ãƒ”ãƒ¼</button>
    </div>
  </div>

  <script>
    // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³åŠ¹æœ
    document.addEventListener('DOMContentLoaded', function() {
      // ã‚¨ãƒ³ãƒ‡ã‚£ãƒ³ã‚°ãƒ†ã‚­ã‚¹ãƒˆã®ãƒ•ã‚§ãƒ¼ãƒ‰ã‚¤ãƒ³
      const endingText = document.querySelector('.ending-text');
      endingText.style.opacity = '0';
      endingText.style.transform = 'translateY(30px)';
      setTimeout(() => {
        endingText.style.transition = 'all 1s ease';
        endingText.style.opacity = '1';
        endingText.style.transform = 'translateY(0)';
      }, 500);

      // ã‚¿ã‚¤ãƒ ãƒ©ã‚¤ãƒ³ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const timelineItems = document.querySelectorAll('.timeline-item');
      timelineItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-30px)';
        setTimeout(() => {
          item.style.transition = 'all 0.5s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateX(0)';
        }, 1000 + (index * 200));
      });
    });

    function shareStory() {
      const shareSection = document.getElementById('share-section');
      if (shareSection.style.display === 'none') {
        shareSection.style.display = 'block';
        shareSection.scrollIntoView({ behavior: 'smooth' });
      } else {
        shareSection.style.display = 'none';
      }
    }

    function copyToClipboard() {
      const shareText = document.getElementById('share-text').textContent;
      navigator.clipboard.writeText(shareText).then(function() {
        alert('ç‰©èªã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      }, function(err) {
        console.error('ã‚³ãƒ”ãƒ¼ã«å¤±æ•—ã—ã¾ã—ãŸ: ', err);
        // ãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯
        const textArea = document.createElement('textarea');
        textArea.value = shareText;
        document.body.appendChild(textArea);
        textArea.select();
        document.execCommand('copy');
        document.body.removeChild(textArea);
        alert('ç‰©èªã‚’ã‚³ãƒ”ãƒ¼ã—ã¾ã—ãŸï¼');
      });
    }
  </script>
  
  <%= render 'shared/footer' %>
</body>
</html>
