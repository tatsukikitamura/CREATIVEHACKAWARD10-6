<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>物語の結末 - AIゲームマスター</title>
  <%= stylesheet_link_tag 'mbti_common', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'mbti_game_master', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'footer', 'data-turbo-track': 'reload' %>
</head>
<body>
  <div class="ending-container">
     <!-- ヘッダー -->
     <div style="text-align: center; margin-bottom: 40px;">
      <br>
       <h1>🏆 物語完結！</h1>
       <br>
       <p><%= @achievement %></p>
     </div>

    <!-- エンディングテキスト -->
    <div class="ending-content">
      <div class="ending-text">
        <%= simple_format(@ending_text) %>
      </div>
    </div>

    <!-- MBTI分析結果 -->
    <div class="analysis-section">
      <h2 class="analysis-title">🎭 あなたの性格分析</h2>
      
      <div class="mbti-result-card">
        <div class="mbti-type-display">
          <h3 class="mbti-type"><%= @result.mbti_type %></h3>
          <p class="mbti-description"><%= @result.description %></p>
        </div>
      </div>

      <div class="analysis-content">
        <div class="analysis-item">
          <h4>📊 MBTI分析</h4>
          <p><%= @mbti_analysis %></p>
        </div>

        <div class="analysis-item">
          <h4>🔍 性格の洞察</h4>
          <p><%= @personality_insights %></p>
        </div>
      </div>
    </div>

     <!-- 物語の振り返り -->
     <div class="story-summary">
       <button class="summary-toggle" onclick="toggleStoryTimeline()">
         <h2 class="summary-title">📖 あなたの物語の軌跡</h2>
         <span class="toggle-icon" id="timeline-icon">▼</span>
       </button>
       <br>
       <div class="story-timeline" id="story-timeline" style="display: none;">
         <% @story_state['history']&.each_with_index do |choice, index| %>
           <div class="timeline-item" style="justify-content: center;">
             <div class="timeline-marker"><%= index + 1 %></div>
             <div class="timeline-content">
               <p>
                 <% if choice.include?('を選択') %>
                   <%# 古い形式のデータを変換 %>
                   <% 
                     # より自然な表現に変換
                     converted_choice = choice.gsub('を選択', '')
                     converted_choice = converted_choice.gsub('外向的な行動', '外向的な選択')
                     converted_choice = converted_choice.gsub('内向的な行動', '内向的な選択')
                     converted_choice = converted_choice.gsub('感覚的な判断', '感覚的な選択')
                     converted_choice = converted_choice.gsub('直感的な判断', '直感的な選択')
                     converted_choice = converted_choice.gsub('論理的な思考', '論理的な選択')
                     converted_choice = converted_choice.gsub('感情的な判断', '感情的な選択')
                     converted_choice = converted_choice.gsub('計画的な行動', '計画的な選択')
                     converted_choice = converted_choice.gsub('柔軟な対応', '柔軟な選択')
                   %>
                   <%= converted_choice %>
                 <% else %>
                   <%# 新しい形式のデータはそのまま表示 %>
                   <%= choice %>
                 <% end %>
               </p>
             </div>
           </div>
         <% end %>
       </div>
     </div>

     <!-- アクションボタン -->
     <div class="ending-actions">
      <!-- <a href="<%= mbti_result_ai_path %>?session_id=<%= @mbti_session.session_id %>" class="action-button primary">AI診断結果を見る</a> -->
       <a href="<%= mbti_mode_selection_path %>" class="action-button secondary">新しい物語を始める</a>
       <a href="<%= mbti_path %>" class="action-button secondary">通常の診断に戻る</a>
     </div>

  </div>

  <script>
    // アニメーション効果
    document.addEventListener('DOMContentLoaded', function() {
      // エンディングテキストのフェードイン
      const endingText = document.querySelector('.ending-text');
      endingText.style.opacity = '0';
      endingText.style.transform = 'translateY(30px)';
      setTimeout(() => {
        endingText.style.transition = 'all 1s ease';
        endingText.style.opacity = '1';
        endingText.style.transform = 'translateY(0)';
      }, 500);

      // タイムラインのアニメーション
      const timelineItems = document.querySelectorAll('.timeline-item');
      timelineItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-30px)';
        setTimeout(() => {
          item.style.transition = 'all 0.5s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateX(0)';
        }, 1000 + (index * 200));
      });
    });


    function toggleStoryTimeline() {
      const timeline = document.getElementById('story-timeline');
      const icon = document.getElementById('timeline-icon');
      
      if (timeline.style.display === 'none') {
        timeline.style.display = 'block';
        icon.textContent = '▲';
        
        // タイムラインのアニメーション
        const timelineItems = document.querySelectorAll('.timeline-item');
        timelineItems.forEach((item, index) => {
          item.style.opacity = '0';
          item.style.transform = 'translateX(-30px)';
          setTimeout(() => {
            item.style.transition = 'all 0.5s ease';
            item.style.opacity = '1';
            item.style.transform = 'translateX(0)';
          }, 100 + (index * 150));
        });
      } else {
        timeline.style.display = 'none';
        icon.textContent = '▼';
      }
    }
  </script>
  
  <%= render 'shared/footer' %>
</body>
</html>
