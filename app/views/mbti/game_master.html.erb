<!DOCTYPE html>
<html lang="ja">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>AIã‚²ãƒ¼ãƒ ãƒã‚¹ã‚¿ãƒ¼ - MBTIè¨ºæ–­</title>
  <%= stylesheet_link_tag 'mbti_common', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'mbti_game_master', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'mbti_themes', 'data-turbo-track': 'reload' %>
  <%= stylesheet_link_tag 'footer', 'data-turbo-track': 'reload' %>
</head>
<body class="theme-<%= @ui_theme %>">
  <div class="game-master-container">
    <!-- ãƒ˜ãƒƒãƒ€ãƒ¼ -->
    <div class="game-header">
      <div class="story-progress">
        <div class="progress-bar">
          <div class="progress-fill" style="width: <%= @progress %>%"></div>
        </div>
        <div class="progress-text">é€²æ—: <%= @progress %>%</div>
      </div>
    </div>

    <!-- ãƒ¡ã‚¤ãƒ³ã‚³ãƒ³ãƒ†ãƒ³ãƒ„ã‚¨ãƒªã‚¢ï¼ˆ1200pxä»¥ä¸Šã§ä¸€åˆ—è¡¨ç¤ºï¼‰ -->
    <div class="main-content-area">
      <!-- è³ªå•æ–‡ã¨é¸æŠè‚¢ã‚’ä¸€ã¤ã®åˆ—ã«ã¾ã¨ã‚ã‚‹ -->
      <div class="story-choices-section">
        <h3><%= @scene_text %></h3>
        
        <div class="choices-container">
          <h3 class="choices-title">ã‚ãªãŸã®é¸æŠ</h3>
          <%= form_with url: mbti_game_master_answer_path, method: :post, local: true, class: "choices-form", data: { turbo: false } do |form| %>
            <%= form.hidden_field :session_id, value: @mbti_session.session_id %>
            <%= form.hidden_field :question_dimension, value: @question_dimension %>
            
            <div class="choices-grid">
              <% @choices.each_with_index do |choice, index| %>
                <div class="choice-item">
                  <%= form.radio_button :choice_value, choice['value'], 
                      id: "choice_#{index}", 
                      class: "choice-radio",
                      required: true %>
                  <%= form.label "choice_value_#{choice['value']}", 
                      choice['text'], 
                      for: "choice_#{index}",
                      class: "choice-label" %>
                  <%= form.hidden_field :progress_impact, value: choice['progress_impact'] %>
                  <%= form.hidden_field :choice_text, value: choice['text'], id: "choice_text_#{index}" %>
                </div>
              <% end %>
            </div>
            
            <!-- è‡ªå‹•é€ä¿¡ã®ãŸã‚ã€submitãƒœã‚¿ãƒ³ã¯éè¡¨ç¤º -->
            <div class="submit-container" style="display: none;">
              <%= form.submit "é¸æŠã™ã‚‹", class: "submit-button" %>
            </div>
          <% end %>
        </div>
      </div>
    </div>

    <!-- ã‚µã‚¤ãƒ‰ãƒãƒ¼ -->
    <div class="game-sidebar">
      <div class="inventory-section">
        <h3>ğŸ’ æŒã¡ç‰©</h3>
        <% if @inventory.any? %>
          <ul class="inventory-list">
            <% @inventory.each do |item| %>
              <li class="inventory-item"><%= item %></li>
            <% end %>
          </ul>
        <% else %>
          <p class="empty-inventory">ã¾ã ä½•ã‚‚æŒã£ã¦ã„ã¾ã›ã‚“</p>
        <% end %>
      </div>

      <div class="story-info">
        <h3>ğŸ“– ç‰©èªæƒ…å ±</h3>
        <div class="info-item">
          <strong>ğŸ¯ ç›®æ¨™:</strong> <%= @goal %>
        </div>
        <div class="info-item">
          <strong>æ¬¡å…ƒ:</strong> <%= @question_dimension %>
        </div>
        <div class="info-item">
          <strong>ãƒ¢ãƒ¼ãƒ‰:</strong> <%= @mbti_session.story_mode&.capitalize || 'Adventure' %>
        </div>
        
        <!-- ãƒ‡ã‚¹ã‚¯ãƒˆãƒƒãƒ—ç‰ˆã®ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼ˆç‰©èªæƒ…å ±ã®ä¸‹ï¼‰ -->
        <div class="home-button-container desktop-only">
          <a href="<%= mbti_path %>" class="home-button">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
        </div>
      </div>
    </div>
    
    <!-- ãƒ¢ãƒã‚¤ãƒ«ç‰ˆã®ãƒ›ãƒ¼ãƒ ãƒœã‚¿ãƒ³ï¼ˆã‚³ãƒ³ãƒ†ãƒŠã®ä¸‹ï¼‰ -->
    <div class="home-button-container mobile-only">
      <a href="<%= mbti_path %>" class="home-button">ğŸ  ãƒ›ãƒ¼ãƒ ã«æˆ»ã‚‹</a>
    </div>
  </div>

  <script>
    // é¸æŠè‚¢ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
    document.addEventListener('DOMContentLoaded', function() {
      const body = document.body;
      const questionElement = document.querySelector('.scene-text');
      const questionText = questionElement.textContent;
      const currentTheme = body.className.match(/theme-(\w+)/);
      
      // è³ªå•ã®å†…å®¹ã«åŸºã¥ã„ã¦è¿½åŠ ã®UIèª¿æ•´ã‚’è¡Œã†
      if (currentTheme) {
        adjustUIForQuestionContent(questionText, currentTheme[1]);
      }

      const choiceItems = document.querySelectorAll('.choice-item');
      choiceItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateY(20px)';
        setTimeout(() => {
          item.style.transition = 'all 0.3s ease';
          item.style.opacity = '1';
          item.style.transform = 'translateY(0)';
        }, index * 100);
      });

      // ãƒ—ãƒ­ã‚°ãƒ¬ã‚¹ãƒãƒ¼ã®ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      const progressFill = document.querySelector('.progress-fill');
      const targetWidth = progressFill.style.width;
      progressFill.style.width = '0%';
      setTimeout(() => {
        progressFill.style.transition = 'width 1s ease';
        progressFill.style.width = targetWidth;
      }, 500);

      // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ†ãƒ¼ãƒåˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
      initializeThemeEffects();
    });

    // é¸æŠè‚¢ã®ã‚¯ãƒªãƒƒã‚¯å‡¦ç†
    function updateSelection() {
      // å…¨ã¦ã®é¸æŠè‚¢ã‹ã‚‰selectedã‚¯ãƒ©ã‚¹ã‚’å‰Šé™¤
      document.querySelectorAll('.choice-item').forEach(item => {
        item.classList.remove('selected');
      });
      
      // é¸æŠã•ã‚ŒãŸé¸æŠè‚¢ã«selectedã‚¯ãƒ©ã‚¹ã‚’è¿½åŠ 
      const checkedRadio = document.querySelector('.choice-radio:checked');
      if (checkedRadio) {
        checkedRadio.parentElement.classList.add('selected');
      }
    }

    // ãƒ©ã‚¸ã‚ªãƒœã‚¿ãƒ³ã®å¤‰æ›´ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè‡ªå‹•é€ä¿¡æ©Ÿèƒ½ä»˜ãï¼‰
    document.querySelectorAll('.choice-radio').forEach(radio => {
      radio.addEventListener('change', function() {
        updateSelection();
        
        // é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
        const choiceItems = document.querySelectorAll('.choice-item');
        choiceItems.forEach(item => {
          item.style.opacity = '0.6';
          item.style.pointerEvents = 'none';
        });
        
        // é¸æŠã•ã‚ŒãŸé¸æŠè‚¢ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
        const selectedItem = this.parentElement;
        const loadingDiv = document.createElement('div');
        loadingDiv.className = 'loading-indicator';
        loadingDiv.textContent = 'é€ä¿¡ä¸­...';
        selectedItem.appendChild(loadingDiv);
        
        // é¸æŠå¾Œã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰è‡ªå‹•é€ä¿¡
        setTimeout(() => {
          const form = this.closest('form');
          if (form) {
            // é¸æŠã•ã‚ŒãŸé¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
            const selectedChoiceText = this.parentElement.querySelector('.choice-label').textContent;
            const choiceTextInput = this.parentElement.querySelector('input[name="choice_text"]');
            if (choiceTextInput) {
              choiceTextInput.value = selectedChoiceText;
            }
            
            console.log('Submitting form...');
            // ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
            form.submit();
          } else {
            console.error('Form not found');
          }
        }, 500); // 0.5ç§’ã®é…å»¶ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã‚’ç¢ºèªã•ã›ã‚‹
      });
    });

    // ãƒ©ãƒ™ãƒ«ã®ã‚¯ãƒªãƒƒã‚¯ã‚¤ãƒ™ãƒ³ãƒˆï¼ˆè‡ªå‹•é€ä¿¡æ©Ÿèƒ½ä»˜ãï¼‰
    document.querySelectorAll('.choice-label').forEach(label => {
      label.addEventListener('click', function(e) {
        e.preventDefault();
        const radio = this.previousElementSibling;
        if (radio && radio.type === 'radio') {
          radio.checked = true;
          updateSelection();
          
          // é¸æŠè‚¢ã‚’ç„¡åŠ¹åŒ–ã—ã¦ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°çŠ¶æ…‹ã‚’è¡¨ç¤º
          const choiceItems = document.querySelectorAll('.choice-item');
          choiceItems.forEach(item => {
            item.style.opacity = '0.6';
            item.style.pointerEvents = 'none';
          });
          
          // é¸æŠã•ã‚ŒãŸé¸æŠè‚¢ã«ãƒ­ãƒ¼ãƒ‡ã‚£ãƒ³ã‚°è¡¨ç¤º
          const selectedItem = radio.parentElement;
          const loadingDiv = document.createElement('div');
          loadingDiv.className = 'loading-indicator';
          loadingDiv.textContent = 'é€ä¿¡ä¸­...';
          selectedItem.appendChild(loadingDiv);
          
          // é¸æŠå¾Œã€å°‘ã—é…å»¶ã—ã¦ã‹ã‚‰è‡ªå‹•é€ä¿¡
          setTimeout(() => {
            const form = radio.closest('form');
            if (form) {
              // é¸æŠã•ã‚ŒãŸé¸æŠè‚¢ã®ãƒ†ã‚­ã‚¹ãƒˆã‚’è¨­å®š
              const selectedChoiceText = this.textContent;
              const choiceTextInput = radio.parentElement.querySelector('input[name="choice_text"]');
              if (choiceTextInput) {
                choiceTextInput.value = selectedChoiceText;
              }
              
              console.log('Submitting form from label click...');
              // ç›´æ¥ãƒ•ã‚©ãƒ¼ãƒ ã‚’é€ä¿¡
              form.submit();
            } else {
              console.error('Form not found from label click');
            }
          }, 500); // 0.5ç§’ã®é…å»¶ã§ãƒ¦ãƒ¼ã‚¶ãƒ¼ã«é¸æŠã‚’ç¢ºèªã•ã›ã‚‹
        }
      });
    });

    // é¸æŠè‚¢ã®ãƒ›ãƒãƒ¼åŠ¹æœ
    document.querySelectorAll('.choice-label').forEach(label => {
      label.addEventListener('mouseenter', function() {
        this.parentElement.classList.add('hovered');
      });
      
      label.addEventListener('mouseleave', function() {
        this.parentElement.classList.remove('hovered');
      });
    });

    // è³ªå•å†…å®¹ã«åŸºã¥ãUIèª¿æ•´é–¢æ•°
    function adjustUIForQuestionContent(questionText, theme) {
      // è³ªå•ã®ã‚­ãƒ¼ãƒ¯ãƒ¼ãƒ‰ã«åŸºã¥ã„ã¦è¿½åŠ ã®èª¿æ•´
      if (questionText.includes('äºº') || questionText.includes('äº¤æµ') || questionText.includes('ä¼šè©±')) {
        // ç¤¾ä¼šçš„ãªè³ªå•ã®å ´åˆ
        addSocialEffects(theme);
      } else if (questionText.includes('è€ƒãˆ') || questionText.includes('åˆ†æ') || questionText.includes('è«–ç†')) {
        // æ€è€ƒçš„ãªè³ªå•ã®å ´åˆ
        addThinkingEffects(theme);
      } else if (questionText.includes('æ„Ÿæƒ…') || questionText.includes('æ°—æŒã¡') || questionText.includes('æ„Ÿã˜')) {
        // æ„Ÿæƒ…çš„ãªè³ªå•ã®å ´åˆ
        addEmotionalEffects(theme);
      } else if (questionText.includes('è¨ˆç”»') || questionText.includes('æ•´ç†') || questionText.includes('æ§‹é€ ')) {
        // æ§‹é€ çš„ãªè³ªå•ã®å ´åˆ
        addStructuralEffects(theme);
      }
    }

    // ãƒ†ãƒ¼ãƒåˆ¥ã®è¿½åŠ ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function addSocialEffects(theme) {
      if (theme === 'dynamic') {
        // ã‚ˆã‚Šæ´»ç™ºãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        document.body.style.animation = 'pulse-dynamic 2s infinite';
      }
    }

    function addThinkingEffects(theme) {
      if (theme === 'analytical') {
        // ã‚ˆã‚Šå†·é™ãªã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
        // è³ªå•æ–‡ã®ã‚µã‚¤ã‚ºå¤‰æ›´ã¯å‰Šé™¤
      }
    }

    function addEmotionalEffects(theme) {
      if (theme === 'emotional') {
        // ã‚ˆã‚Šæ¸©ã‹ã¿ã®ã‚ã‚‹ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        document.body.style.boxShadow = '0 20px 40px rgba(253, 121, 168, 0.2)';
      }
    }

    function addStructuralEffects(theme) {
      if (theme === 'structured') {
        // ã‚ˆã‚Šæ•´ç„¶ã¨ã—ãŸã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
        document.body.style.border = '2px solid var(--primary-color)';
      }
    }

    // ãƒšãƒ¼ã‚¸èª­ã¿è¾¼ã¿æ™‚ã®ãƒ†ãƒ¼ãƒåˆ¥ã‚¨ãƒ•ã‚§ã‚¯ãƒˆ
    function initializeThemeEffects() {
      const body = document.body;
      const currentTheme = body.className.match(/theme-(\w+)/);
      if (!currentTheme) return;

      const theme = currentTheme[1];

      // ãƒœãƒ‡ã‚£ã®åˆæœŸã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³
      body.style.opacity = '0';
      body.style.transform = 'translateY(20px)';
      
      setTimeout(() => {
        body.style.transition = 'all 0.6s ease-out';
        body.style.opacity = '1';
        body.style.transform = 'translateY(0)';
      }, 100);

      // é¸æŠè‚¢ã®é †æ¬¡è¡¨ç¤º
      const choiceItems = document.querySelectorAll('.choice-item');
      choiceItems.forEach((item, index) => {
        item.style.opacity = '0';
        item.style.transform = 'translateX(-20px)';
        
        setTimeout(() => {
          item.style.transition = 'all 0.4s ease-out';
          item.style.opacity = '1';
          item.style.transform = 'translateX(0)';
        }, 300 + (index * 100));
      });
    }
  </script>
  
</body>
</html>
